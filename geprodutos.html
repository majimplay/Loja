<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="generator" content="RocketCake">
	<title>Gerenciamento de Produtos</title>
	<link rel="stylesheet" type="text/css" href="estilos/geprodutos_html.css?h=ae68fce6">
   <link rel="stylesheet" href="estilos/cabecaio.css">
    <style>
        /* Estilos para feedback de carregamento nos botões */
        .buttonStyle.disabled, .btnAcao.disabled {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #A2BF3F; /* Cor do seu tema */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Ajustes para botões de ação na tabela */
        #Tabeladeprodutos .acoes-container div {
            cursor: pointer;
            padding: 4px;
            margin-bottom: 4px;
            border-radius: 4px;
            text-align: center;
            font-size: 18px; /* Tamanho dos ícones */
        }
        #Tabeladeprodutos .acoes-container div:hover {
            background-color: #f0f0f0;
        }
        #Tabeladeprodutos .btnEditarProduto, #Tabeladeprodutos .btnExcluirProduto {
            font-size: 12px; /* Tamanho do texto para editar/excluir */
        }

        /* Estilo para inputs na tabela de produtos */
        .CAXADETEXTONOMEPRODUTO, .CAXADETEXTOPRECOPRODUTO {
            width: 95%;
            padding: 6px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .CAXADETEXTONOMEPRODUTO {
            resize: vertical; /* Permite redimensionar verticalmente */
        }

    </style>
</head>
<body>

    <div class="header-container">
        <div class="containerStyle">
            <div class="containerPadding">
                <div id="userInfo" class="hidden">
                    <div style="display: flex; align-items: center;">
                        <img id="userPhoto" src="" alt="Foto" style="width:100px; height:100px; border-radius:50%; margin-right:20px;">
                        <div>
                            <h2 style="font-size:24pt; color:#A2BF3F;">Bem-vindo, <span id="userName"></span>!</h2>
                            <p style="font-size:12pt; color:#FFFFFF;"><strong>Email:</strong> <span id="userEmail"></span></p>
                        </div>
                    </div>
                    <div class="button-container">
                       <a href="novapagina.html" target="_blank" class="buttonStyle">Registro</a>
                        <a href="perfil.html" id="contaLink" class="buttonStyle">Meu Perfil</a>
                        <a href="criarloja.html" id="lojaLink" class="buttonStyle">Minha Loja</a>
                        <button class="buttonStyle" disabled>Aiframe 1</button>
                        <button class="buttonStyle" disabled>Aiframe 2</button>
                        <button id="logoutButton" class="buttonStyle">Sair</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="statusMessage" style="text-align: center; padding: 10px; font-weight: bold;"></div>
    </div>


<div class="textstyle1">
<span class="textstyle2">Gerenciamento de Produtos<br/></span><div id="container_64485fad"><div id="container_64485fad_padding" ><div class="textstyle1"><span class="textstyle3">Clique ou arraste para adicionar imagem</span><span class="textstyle4"> <br/></span><div id="imagedrop_here"><div class="vcenterstyle1"><div class="vcenterstyle2"></div></div></div><span class="textstyle3"> <br/></span>

<div id="container_imagens_adicionar" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top:10px; border: 1px dashed #ccc; padding:10px; min-height: 80px;">
    </div>
<div id="container_5cbd2978"><div id="container_5cbd2978_padding" ><div class="textstyle5"><table id="tabelaaddproduto" cellpadding="3" cellspacing="1" >	<tr>
		<td width="35%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_43dea141">
    <div class="textstyle5">
<input type="text" value="" title="Nome do Produto" name="inputprodutonome"  id="inputProdutoNome" placeholder="Nome do Produto">
      </div>
    </div>
		</td>
		<td width="10%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_1809c9fc">
    <div class="textstyle5">
<input type="text" value="" title="Preço" name="inputprodutopreco"  id="inputProdutoPreco" placeholder="Preço (ex: 29.90)">
      </div>
    </div>
		</td>
		<td width="8%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_741b1441">
    <div class="textstyle5">
<input type="text" value="" title="Peso (kg)" name="inputprodutopeso"  id="inputProdutoPeso" placeholder="Peso (kg)">
      </div>
    </div>
		</td>
		<td width="8%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_60dba8b2">
    <div class="textstyle5">
<input type="text" value="" title="Altura (cm)" name="inputprodutoaltura"  id="inputProdutoAltura" placeholder="Altura (cm)">
      </div>
    </div>
		</td>
		<td width="10%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_63efa2b7">
    <div class="textstyle5">
<input type="text" value="" title="Largura (cm)" name="inputprodutolargura"  id="inputProdutoLargura" placeholder="Largura (cm)">
      </div>
    </div>
		</td>
		<td width="26%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_274cbdb6">
    <div class="textstyle5">
<input type="text" value="" title="Comprimento (cm)" name="inputprodutocomprimento"  id="inputProdutoComprimento" placeholder="Comprimento (cm)">
      </div>
    </div>
		</td>
	</tr>
	<tr>
		<td width="35%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_526a9cdd">    <div class="textstyle5">      <span class="textstyle6">Nome</span>      </div>    </div>		</td>
		<td width="10%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_5ad1743c">    <div class="textstyle5">      <span class="textstyle6">Preço</span>      </div>    </div>		</td>
		<td width="8%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_55cd82bf">    <div class="textstyle5">      <span class="textstyle6">Peso</span>      </div>    </div>		</td>
		<td width="8%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_1efa2331">    <div class="textstyle5">      <span class="textstyle6">Altura</span>      </div>    </div>		</td>
		<td width="10%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_68473273">    <div class="textstyle5">      <span class="textstyle6">Largura</span>      </div>    </div>		</td>
		<td width="26%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_557d032a">    <div class="textstyle5">      <span class="textstyle6">Comprimento</span>      </div>    </div>		</td>
	</tr>
</table><span class="textstyle7"><br/></span></div>
<div class="textstyle1"><div id="btnAdicionarProduto" class="buttonStyle" style="width: 200px; margin: 10px auto; background-color: #A2BF3F; color: white; padding: 10px; border-radius: 5px; text-align: center; cursor: pointer;"><div class="vcenterstyle1"><div class="vcenterstyle2"><div class="textstyle1">  <span class="textstyle4">Adicionar Produto</span>
</div>
</div></div></div></div>
<div style="clear:both"></div></div></div></div>
<div style="clear:both"></div></div></div><span class="textstyle2"><hr style="margin: 10px ;">Meus Produtos<hr style="margin: 10px ;"></span>  </div>
<div class="textstyle5">
<div id="container_9954efc"><div id="container_9954efc_padding" ><div class="textstyle5"><span class="textstyle8"><br/></span>
<table id="Tabeladeprodutos" cellpadding="3" cellspacing="1" style="width:100%; border-collapse: collapse;">
    <thead>
        <tr>
            <th width="40%" style="text-align:left; padding: 8px; border-bottom: 1px solid #ddd;">Imagens</th>
            <th width="30%" style="text-align:left; padding: 8px; border-bottom: 1px solid #ddd;">Nome</th>
            <th width="15%" style="text-align:left; padding: 8px; border-bottom: 1px solid #ddd;">Preço</th>
            <th width="15%" style="text-align:center; padding: 8px; border-bottom: 1px solid #ddd;">Ações</th>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
</div>
<div style="clear:both"></div></div></div>  </div>
<div class="textstyle1">
<span class="textstyle2"><br/><br/><br/><br/><br/></span>  </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="scripts/login.js"></script>
    <script src="scripts/geprodutos.js"></script>

<script>
// URL do Google Apps Script Web App
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRjL-iQVhiVWSPeTyb4AEkYm4tSPeAsL0J6AHqS_S5CtY7iR6xY6lOk1KbN7vY_NnY/exec'; // MANTENHA SUA URL CORRETA

// Variável para controlar submissões e evitar cliques duplos
let isSubmittingProductAction = false;

// Função para exibir mensagens de status
function showStatusMessage(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
        setTimeout(() => {
            if (statusDiv.textContent === message) statusDiv.textContent = '';
        }, 5000); // Limpa a mensagem após 5 segundos
    }
    if (type === 'error') console.error(message);
    else console.log(message);
}

// Função para recarregar a lista de produtos (chamada após ordenação ou se necessário)
async function reloadStoreProducts() {
    if (!window.decodedToken || !window.decodedToken.sub) {
        showStatusMessage("Usuário não autenticado. Não é possível recarregar produtos.", "error");
        return;
    }
    const gogoid = window.decodedToken.sub;
    const statusDiv = document.getElementById('statusMessage');
    if(statusDiv) statusDiv.textContent = 'Recarregando produtos...';

    try {
        // Esta parte é uma simplificação. Idealmente, você chamaria a mesma lógica
        // que `login.js` usa para popular a tabela, ou refatoraria essa lógica
        // para uma função reutilizável que ambos os scripts possam chamar.
        // Por agora, vamos apenas limpar e indicar que precisa ser recarregado.
        
        // Limpa a tabela atual
        const produtosTableBody = document.querySelector('#Tabeladeprodutos tbody');
        if (produtosTableBody) produtosTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Recarregando...</td></tr>';
        
        // Chama a função de carregamento de produtos do login.js (se ela estiver global e adaptada para isso)
        // ou força um refresh da página para uma solução mais simples, mas menos elegante.
        // window.loadUserAndProducts(); // Supondo que você refatore login.js para ter essa função globalmente
        
        // Solução simples: Forçar o login.js a rodar sua lógica de carregamento novamente.
        // Isso pode ser complexo sem refatorar login.js.
        // A maneira mais fácil de "recarregar" é fazer um novo fetch e reconstruir a tabela.
        // A função fetchProdutosDaLoja em login.js já faz isso. Podemos chamá-la se estiver no escopo global.
        // Como uma alternativa mais robusta, a função de popular a tabela deveria ser separada em login.js
        // para que possa ser chamada daqui.

        // Por ora, uma mensagem e o usuário pode precisar recarregar a página manualmente após ordenação
        // para ver a ordem correta refletida do servidor, ou implementamos a reordenação visual no cliente também.
        
        // Tentativa de chamar a lógica de carregamento de login.js (requer que ela seja acessível)
        if (typeof loadAndDisplayStoreProducts === "function") { // Supondo que você crie essa função em login.js
            await loadAndDisplayStoreProducts(gogoid);
        } else {
            showStatusMessage("Produtos ordenados no servidor. Atualize a página para ver a nova ordem.", "success");
            // Ou, para uma atualização mais dinâmica, você pode reordenar os elementos no DOM aqui
            // com base na nova ordem retornada pelo servidor.
        }

    } catch (error) {
        showStatusMessage(`Erro ao recarregar produtos: ${error.message}`, "error");
    }
}


// === Script para Adicionar Produto (já existente, com pequenas melhorias) ===
let isSubmittingAddProduct = false;
document.getElementById('btnAdicionarProduto').addEventListener('click', async () => {
    if (isSubmittingAddProduct) return;
    isSubmittingAddProduct = true;

    const btn = document.getElementById('btnAdicionarProduto');
    const originalContent = btn.innerHTML;
    btn.classList.add('disabled');
    btn.innerHTML = 'Enviando... <div class="loading-spinner"></div>';
    showStatusMessage("Adicionando produto...", "info");

    try {
        const imageUrls = [];
        // 'imagesToAdd' e 'uploadImageToImgBB' vêm de geprodutos.js
        if (typeof imagesToAdd !== 'undefined' && typeof uploadImageToImgBB === 'function') {
            for (const imageData of imagesToAdd) {
                const url = await uploadImageToImgBB(imageData); // uploadImageToImgBB está em geprodutos.js
                if (url) imageUrls.push(url);
            }
        } else {
            console.warn("imagesToAdd ou uploadImageToImgBB não estão definidos. Upload de imagens pulado.");
        }
        

        const produto = {
            action: "add",
            productData: {
                GOGOID: window.decodedToken?.sub,
                NOME: document.getElementById('inputProdutoNome').value,
                PRECO: document.getElementById('inputProdutoPreco').value,
                PESO: document.getElementById('inputProdutoPeso').value,
                ALTURA: document.getElementById('inputProdutoAltura').value,
                LARGURA: document.getElementById('inputProdutoLargura').value,
                COMPRIMENTO: document.getElementById('inputProdutoComprimento').value,
                IMAGENS: imageUrls.join(', ') // Junta URLs das imagens
            }
        };

        if (!produto.productData.NOME || !produto.productData.PRECO) {
            showStatusMessage("Nome e Preço são obrigatórios.", "error");
            throw new Error("Nome e Preço são obrigatórios.");
        }
        if (!produto.productData.GOGOID) {
            showStatusMessage("Usuário não identificado (GOGOID). Faça login novamente.", "error");
            throw new Error("GOGOID não encontrado.");
        }

        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            // mode: 'no-cors', // Removido pois o Apps Script agora retorna JSON corretamente
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(produto)
        });

        // const responseText = await response.text(); // Para depuração se não for JSON
        // console.log("Raw add product response:", responseText);
        // const result = JSON.parse(responseText);
        
        if (!response.ok) { // Verifica se a resposta HTTP foi bem-sucedida (status 2xx)
             const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status} ao adicionar produto.` }));
             throw new Error(errorData.message || `Erro ${response.status} ao adicionar produto.`);
        }
        const result = await response.json();


        if (result.status === 'success') {
            showStatusMessage('Produto cadastrado com sucesso! ID: ' + result.productId, 'success');
            // Limpar campos do formulário e imagens
            document.getElementById('inputProdutoNome').value = '';
            document.getElementById('inputProdutoPreco').value = '';
            document.getElementById('inputProdutoPeso').value = '';
            document.getElementById('inputProdutoAltura').value = '';
            document.getElementById('inputProdutoLargura').value = '';
            document.getElementById('inputProdutoComprimento').value = '';
            if (typeof imagesToAdd !== 'undefined' && typeof displayImagesToAdd === 'function') {
                imagesToAdd = []; // Limpa o array de imagens a adicionar
                displayImagesToAdd(); // Atualiza a exibição (deve limpar o container)
            }
            await reloadStoreProducts(); // Recarrega a lista de produtos
        } else {
            throw new Error(result.message || 'Falha ao adicionar produto no servidor.');
        }

    } catch (error) {
        showStatusMessage(`Erro ao adicionar produto: ${error.message}`, 'error');
    } finally {
        isSubmittingAddProduct = false;
        btn.classList.remove('disabled');
        btn.innerHTML = originalContent;
    }
});


// === Lógica para Ações na Tabela de Produtos (Mover, Editar, Excluir) ===
const tabelaProdutosBody = document.querySelector('#Tabeladeprodutos tbody');

if (tabelaProdutosBody) {
    tabelaProdutosBody.addEventListener('click', async (event) => {
        const target = event.target.closest('.btnAcao'); // Pega o botão de ação mais próximo
        if (!target) return; // Sai se o clique não foi em um botão de ação

        if (isSubmittingProductAction) {
            showStatusMessage("Aguarde, uma operação está em andamento.", "info");
            return;
        }
        isSubmittingProductAction = true;
        
        const originalButtonContent = target.innerHTML;
        target.classList.add('disabled');
        target.innerHTML = '<div class="loading-spinner"></div>';
        showStatusMessage("Processando...", "info");

        const productId = target.dataset.productId;
        const gogoid = window.decodedToken?.sub;

        if (!gogoid) {
            showStatusMessage("Usuário não identificado (GOGOID). Faça login novamente.", "error");
            isSubmittingProductAction = false;
            target.classList.remove('disabled');
            target.innerHTML = originalButtonContent;
            return;
        }
        if (!productId && !target.classList.contains('btnMoverCima') && !target.classList.contains('btnMoverBaixo')) {
            // Para mover, o productId é pego de forma diferente se não estiver no botão
             const row = target.closest('tr');
             const editOrDeleteButton = row.querySelector('.btnEditarProduto[data-product-id], .btnExcluirProduto[data-product-id]');
             if (editOrDeleteButton) {
                 // productId = editOrDeleteButton.dataset.productId; // Esta linha estava comentada, mas é necessária
             } else {
                showStatusMessage("ID do produto não encontrado para a ação.", "error");
                isSubmittingProductAction = false;
                target.classList.remove('disabled');
                target.innerHTML = originalButtonContent;
                return;
             }
        }


        try {
            let payload = { gogoid };
            let actionEndpoint = "";

            if (target.classList.contains('btnMoverCima') || target.classList.contains('btnMoverBaixo')) {
                actionEndpoint = "ordenarproduto";
                const row = target.closest('tr');
                // Tenta pegar o productId de um botão de editar/excluir na mesma linha
                const siblingEditButton = row.querySelector('.btnEditarProduto[data-product-id]');
                const siblingDeleteButton = row.querySelector('.btnExcluirProduto[data-product-id]');
                let currentProductId = null;

                if (siblingEditButton) currentProductId = siblingEditButton.dataset.productId;
                else if (siblingDeleteButton) currentProductId = siblingDeleteButton.dataset.productId;
                
                if (!currentProductId) throw new Error("Não foi possível encontrar o ID do produto para mover.");

                payload.action = actionEndpoint;
                payload.productId = currentProductId;
                payload.direction = target.classList.contains('btnMoverCima') ? 'up' : 'down';
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}` }));
                    throw new Error(errorData.message || `Erro ao ordenar produto.`);
                }
                const result = await response.json();

                if (result.status === 'success') {
                    showStatusMessage(result.message || 'Produto ordenado!', 'success');
                    // Para atualizar a UI: recarregar produtos ou reordenar no DOM
                    // Reordenar no DOM é mais complexo, recarregar é mais simples
                    await reloadStoreProducts(); // Chama a função para recarregar
                } else {
                    throw new Error(result.message || 'Falha ao ordenar produto.');
                }

            } else if (target.classList.contains('btnEditarProduto')) {
                actionEndpoint = "edit";
                const row = target.closest('tr');
                const nomeInput = row.querySelector('.CAXADETEXTONOMEPRODUTO');
                const precoInput = row.querySelector('.CAXADETEXTOPRECOPRODUTO');
                // Outros campos como PESO, ALTURA, etc., não estão nos inputs da linha por padrão no seu HTML.
                // Se estivessem, você os pegaria aqui.
                // A IMAGENS também é complexa de editar inline aqui.

                if (!nomeInput || !precoInput) throw new Error("Campos de nome ou preço não encontrados na linha.");

                let precoValue = precoInput.value.replace('R$', '').replace(',', '.').trim();

                payload.action = actionEndpoint;
                payload.PRODUCT_ID = productId; // ID do produto a ser editado
                payload.productData = {
                    NOME: nomeInput.value,
                    PRECO: precoValue
                    // Adicione outros campos aqui se eles forem editáveis na linha:
                    // PESO: row.querySelector('.inputPesoProduto').value,
                    // IMAGENS: // Lógica para obter URLs de imagens editadas
                };
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}` }));
                    throw new Error(errorData.message || `Erro ao editar produto.`);
                }
                const result = await response.json();

                if (result.status === 'success') {
                    showStatusMessage(result.message || 'Produto atualizado!', 'success');
                    // Atualizar visualmente os campos se necessário, ou apenas mostrar mensagem
                } else if (result.status === 'info') {
                    showStatusMessage(result.message || 'Nenhuma alteração feita.', 'info');
                } else {
                    throw new Error(result.message || 'Falha ao editar produto.');
                }

            } else if (target.classList.contains('btnExcluirProduto')) {
                actionEndpoint = "delete";
                if (!confirm(`Tem certeza que deseja excluir o produto ID: ${productId}?`)) {
                    isSubmittingProductAction = false;
                    target.classList.remove('disabled');
                    target.innerHTML = originalButtonContent;
                    showStatusMessage("Exclusão cancelada.", "info");
                    return;
                }

                payload.action = actionEndpoint;
                payload.PRODUCT_ID = productId;
                payload.GOGOID = gogoid; // GOGOID é necessário para o backend remover da lista da loja

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}` }));
                    throw new Error(errorData.message || `Erro ao excluir produto.`);
                }
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatusMessage(result.message || 'Produto excluído!', 'success');
                    target.closest('tr').remove(); // Remove a linha da tabela
                } else {
                    throw new Error(result.message || 'Falha ao excluir produto.');
                }
            }

        } catch (error) {
            showStatusMessage(`Erro na ação: ${error.message}`, 'error');
        } finally {
            isSubmittingProductAction = false;
            if (target) { // Verifica se target ainda é válido
                 target.classList.remove('disabled');
                 target.innerHTML = originalButtonContent;
            }
        }
    });
} else {
    console.error("Corpo da tabela de produtos (#Tabeladeprodutos tbody) não encontrado.");
}

// Garantir que window.decodedToken esteja disponível (carregado por login.js)
// O login.js deve ser carregado antes deste script.
window.addEventListener('load', () => {
    if (!window.decodedToken) {
        console.warn("window.decodedToken não está definido no momento do load de geprodutos.html. Verifique a ordem de carregamento dos scripts.");
        // Poderia tentar buscar do localStorage novamente, mas login.js já deve fazer isso.
    }
    // A função applyCarousel para #container_imagens_adicionar é chamada em geprodutos.js
    // A função applyCarousel para os carrosseis de produtos na tabela é chamada em login.js
    // após popular a tabela.
});

</script>
	
</body>
</html>
