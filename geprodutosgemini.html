<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="generator" content="RocketCake">
	<title>Gerenciamento de Produtos</title>
	<link rel="stylesheet" type="text/css" href="estilos/geprodutos_html.css?h=ae68fce6">
   <link rel="stylesheet" href="estilos/cabecaio.css">
    <style>
        /* Estilos básicos para o carrossel de imagens do produto */
        .product-image-carousel {
            display: flex;
            overflow-x: auto; /* Permite rolagem horizontal */
            overflow-y: hidden;
            white-space: nowrap; /* Impede que as imagens quebrem linha */
            cursor: grab;
            border: 1px solid #ddd;
            padding: 5px;
            background-color: #f9f9f9;
            min-height: 100px; /* Altura mínima para visualização */
            align-items: center; /* Centraliza imagens verticalmente se forem menores */
        }

        .product-image-carousel img {
            max-height: 150px; /* Altura máxima das imagens no carrossel */
            margin-right: 10px; /* Espaçamento entre as imagens */
            border: 1px solid #ccc;
            border-radius: 4px;
            object-fit: cover; /* Garante que a imagem cubra a área sem distorcer */
        }

        .product-image-carousel.active {
            cursor: grabbing;
        }

        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            display: inline-block;
            animation: spin 1s ease infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #btnAdicionarProduto.disabled {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Adicionando estilo para botões de ação na tabela */
        .action-button {
            padding: 5px 10px;
            margin: 2px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .action-button:hover {
            background-color: #e0e0e0;
        }

        /* Ajustes na tabela de produtos para melhor visualização */
        #Tabeladeprodutos td {
            vertical-align: middle; /* Alinha conteúdo das células verticalmente */
            padding: 8px; /* Adiciona algum preenchimento */
        }
        #Tabeladeprodutos th, #Tabeladeprodutos thead td { /* Estilizando cabeçalhos */
             text-align: left;
             padding: 8px;
             background-color: #f2f2f2;
             font-weight: bold;
             border: 1px solid #ddd;
        }

    </style>
</head>
<body>

    <div class="header-container">
        <div class="containerStyle">
            <div class="containerPadding">
                <div id="userInfo" class="hidden">
                    <div style="display: flex; align-items: center;">
                        <img id="userPhoto" src="" alt="Foto do Usuário" style="width:100px; height:100px; border-radius:50%; margin-right:20px;" onerror="this.src='https://placehold.co/100x100/eeeeee/cccccc?text=Foto'">
                        <div>
                            <h2 style="font-size:24pt; color:#A2BF3F;">Bem-vindo, <span id="userName"></span>!</h2>
                            <p style="font-size:12pt; color:#FFFFFF;"><strong>Email:</strong> <span id="userEmail"></span></p>
                        </div>
                    </div>
                    <div class="button-container">
                       <a href="novapagina.html" target="_blank" class="buttonStyle">Registro</a>
                        <a href="perfil.html" id="contaLink" class="buttonStyle">Meu Perfil</a>
                        <a href="criarloja.html" id="lojaLink" class="buttonStyle">Minha Loja</a>
                        <button class="buttonStyle" disabled>Aiframe 1</button>
                        <button class="buttonStyle" disabled>Aiframe 2</button>
                        <button id="logoutButton" class="buttonStyle">Sair</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="statusMessage" style="text-align: center; padding: 10px; color: #333;"></div>
    </div>


<div class="textstyle1">
<span class="textstyle2">Gerenciamento de produtos<br/></span><div id="container_64485fad"><div id="container_64485fad_padding" ><div class="textstyle1"><span class="textstyle3">Clique ou arraste para adicionar imagem</span><span class="textstyle4"> <br/></span><div id="imagedrop_here"><div class="vcenterstyle1"><div class="vcenterstyle2"></div></div></div><span class="textstyle3"> <br/></span>

<div id="container_imagens_adicionar" class="product-image-carousel" style="min-height: 120px; margin-bottom:15px;">
    </div>
<div id="container_5cbd2978"><div id="container_5cbd2978_padding" ><div class="textstyle5"><table id="tabelaaddproduto" cellpadding="3" cellspacing="1" >	<tr>
		<td width="35%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_43dea141">
    <div class="textstyle5">
<input type="text" value="" title="Nome do Produto" name="inputprodutonome"  id="inputProdutoNome" placeholder="Nome do Produto">
      </div>
    </div>
		</td>
		<td width="10%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_1809c9fc">
    <div class="textstyle5">
<input type="text" value="" title="Preço do Produto" name="inputprodutopreco"  id="inputProdutoPreco" placeholder="Preço">
      </div>
    </div>
		</td>
		<td width="8%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_741b1441">
    <div class="textstyle5">
<input type="text" value="" title="Peso do Produto" name="inputprodutopeso"  id="inputProdutoPeso" placeholder="Peso">
      </div>
    </div>
		</td>
		<td width="8%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_60dba8b2">
    <div class="textstyle5">
<input type="text" value="" title="Altura do Produto" name="inputprodutoaltura"  id="inputProdutoAltura" placeholder="Altura">
      </div>
    </div>
		</td>
		<td width="10%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_63efa2b7">
    <div class="textstyle5">
<input type="text" value="" title="Largura do Produto" name="inputprodutolargura"  id="inputProdutoLargura" placeholder="Largura">
      </div>
    </div>
		</td>
		<td width="26%" height="24px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_274cbdb6">
    <div class="textstyle5">
<input type="text" value="" title="Comprimento do Produto" name="TextEdit5"  id="inputProdutoComprimento" placeholder="Comprimento">
      </div>
    </div>
		</td>
	</tr>
	<tr>
		<td width="35%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_526a9cdd">
    <div class="textstyle5">
      <span class="textstyle6">Nome</span>
      </div>
    </div>
		</td>
		<td width="10%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_5ad1743c">
    <div class="textstyle5">
      <span class="textstyle6">Preço</span>
      </div>
    </div>
		</td>
		<td width="8%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_55cd82bf">
    <div class="textstyle5">
      <span class="textstyle6">Peso (kg)</span>
      </div>
    </div>
		</td>
		<td width="8%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_1efa2331">
    <div class="textstyle5">
      <span class="textstyle6">Altura (cm)</span>
      </div>
    </div>
		</td>
		<td width="10%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_68473273">
    <div class="textstyle5">
      <span class="textstyle6">Largura (cm)</span>
      </div>
    </div>
		</td>
		<td width="26%" height="52px" style="vertical-align: top; overflow:hidden; ">  <div id="cell_557d032a">
    <div class="textstyle5">
      <span class="textstyle6">Comprimento (cm)</span>
      </div>
    </div>
		</td>
	</tr>
</table><span class="textstyle7"><br/></span></div>
<div class="textstyle1"><div id="btnAdicionarProduto"><div class="vcenterstyle1"><div class="vcenterstyle2"><div class="textstyle1">  <span class="textstyle4">Adicionar Produto</span>
</div>
</div></div></div></div>
<div style="clear:both"></div></div></div></div>
<div style="clear:both"></div></div></div><span class="textstyle2"><hr style="margin: 10px ;">Meus Produtos<hr style="margin: 10px ;"></span>  </div>
<div class="textstyle5">
<div id="container_9954efc"><div id="container_9954efc_padding" ><div class="textstyle5"><span class="textstyle8"><br/></span>
<table id="Tabeladeprodutos" cellpadding="3" cellspacing="1" style="width:100%; border-collapse: collapse;">
    <thead> <tr>
            <td width="40%">Imagens</td>
            <td width="30%">Nome</td>
            <td width="15%">Preço</td>
            <td width="15%">Ações</td>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
</div>
<div style="clear:both"></div></div></div>  </div>
<div class="textstyle1">
<span class="textstyle2"><br/><br/><br/><br/><br/></span>  </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="scripts/login.js"></script>
    <script src="scripts/geprodutos.js"></script>

<script>
// === Script para Adicionar Produto ===
let isSubmitting = false;
// Certifique-se que o URL do script está correto e é o da IMPLANTAÇÃO ATIVA
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRjL-iQVhiVWSPeTyb4AEkYm4tSPeAsL0J6AHqS_S5CtY7iR6xY6lOk1KbN7vY_NnY/exec';

document.getElementById('btnAdicionarProduto').addEventListener('click', async () => {
    if (isSubmitting) return;
    
    const btn = document.getElementById('btnAdicionarProduto');
    const originalContent = btn.innerHTML;

    try {
        isSubmitting = true;
        btn.classList.add('disabled'); 
        btn.innerHTML = 'Enviando... <div class="loading-spinner"></div>'; 

        const imageUrls = [];
        for (const imageData of imagesToAdd) { 
            const url = await uploadImageToImgBB(imageData); 
            if (url) imageUrls.push(url);
        }

        const produto = {
            action: "add",
            productData: {
                GOGOID: window.decodedToken?.sub, 
                NOME: document.getElementById('inputProdutoNome').value,
                PRECO: document.getElementById('inputProdutoPreco').value,
                PESO: document.getElementById('inputProdutoPeso').value,
                ALTURA: document.getElementById('inputProdutoAltura').value,
                LARGURA: document.getElementById('inputProdutoLargura').value,
                COMPRIMENTO: document.getElementById('inputProdutoComprimento').value,
                IMAGENS: imageUrls.join(', ') 
            }
        };

        if (!produto.productData.NOME || !produto.productData.PRECO || !produto.productData.GOGOID) {
            alert('Nome, Preço e Login são obrigatórios para adicionar um produto.');
            throw new Error('Dados incompletos para adicionar produto.'); 
        }
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', // MUDANÇA: Usar 'cors' para poder ler a resposta
            cache: 'no-cache',
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(produto)
        });

        if (!response.ok) {
            // Tenta ler a mensagem de erro do servidor se houver
            let errorData = { message: `Erro HTTP: ${response.status}`};
            try {
                errorData = await response.json();
            } catch (e) { /* Não conseguiu parsear JSON, usa mensagem HTTP */ }
            throw new Error(errorData.message || `Erro ao adicionar produto: ${response.statusText}`);
        }

        const result = await response.json(); // Espera uma resposta JSON do Apps Script

        if (result.status === 'success') {
            alert(result.message || 'Produto cadastrado com sucesso!');
            document.getElementById('inputProdutoNome').value = '';
            document.getElementById('inputProdutoPreco').value = '';
            document.getElementById('inputProdutoPeso').value = '';
            document.getElementById('inputProdutoAltura').value = '';
            document.getElementById('inputProdutoLargura').value = '';
            document.getElementById('inputProdutoComprimento').value = '';
            imagesToAdd = []; 
            displayImagesToAdd(); 
            loadUserProducts(); // Recarrega os produtos
        } else {
            throw new Error(result.message || 'Falha ao cadastrar produto no servidor.');
        }

    } catch (error) {
        console.error('Erro ao adicionar produto:', error);
        alert(`Falha ao enviar produto: ${error.message}`);
    } finally {
        isSubmitting = false;
        btn.classList.remove('disabled'); 
        btn.innerHTML = originalContent; 
    }
});
</script>

<script>
// === SCRIPT PARA CARREGAR E EXIBIR PRODUTOS ===

/**
 * Torna um elemento de slider arrastável horizontalmente.
 */
function makeSliderDraggable(sliderElement) {
    if (!sliderElement) return;
    let isDown = false;
    let startX, scrollStart;

    sliderElement.addEventListener('pointerdown', (e) => {
        isDown = true;
        sliderElement.classList.add('active');
        try { 
            sliderElement.setPointerCapture(e.pointerId);
        } catch (error) {
            // console.warn("setPointerCapture não suportado ou erro:", error);
        }
        startX = e.clientX;
        scrollStart = sliderElement.scrollLeft;
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') { // Evita conflito com botões dentro do carrossel
             e.preventDefault();
        }
    });

    sliderElement.addEventListener('pointerleave', () => { 
        if (isDown) {
            isDown = false;
            sliderElement.classList.remove('active');
             // Não há e.pointerId aqui de forma confiável, então não chamamos releasePointerCapture
        }
    });
    
    sliderElement.addEventListener('pointerup', (e) => {
        if (isDown) {
            isDown = false;
            sliderElement.classList.remove('active');
            try { 
                sliderElement.releasePointerCapture(e.pointerId);
            } catch (error) {
                // console.warn("releasePointerCapture não suportado ou erro:", error);
            }
        }
    });

    sliderElement.addEventListener('pointermove', (e) => {
        if (!isDown) return;
        // e.preventDefault(); // Removido daqui para permitir scroll vertical da página se necessário
        const walk = (e.clientX - startX) * 1.5; 
        sliderElement.scrollLeft = scrollStart - walk;
    });
}


/**
 * Exibe os produtos na tabela 'Tabeladeprodutos'.
 */
function displayProductsInTable(products) {
    const table = document.getElementById('Tabeladeprodutos');
    if (!table) {
        console.error("Elemento 'Tabeladeprodutos' não encontrado.");
        return;
    }

    let tbody = table.querySelector('tbody');
    if (!tbody) {
        tbody = document.createElement('tbody');
        table.appendChild(tbody);
    }
    tbody.innerHTML = ''; 

    if (!products || products.length === 0) {
        const tr = tbody.insertRow();
        const cell = tr.insertCell();
        cell.colSpan = 4; 
        cell.textContent = 'Nenhum produto encontrado para este usuário.';
        cell.style.textAlign = 'center';
        return;
    }

    products.forEach(product => {
        const tr = tbody.insertRow();

        const imgCell = tr.insertCell();
        imgCell.style.width = "40%"; 
        const carouselDiv = document.createElement('div');
        carouselDiv.className = 'product-image-carousel';
        
        if (product.IMAGENS && typeof product.IMAGENS === 'string') {
            const imageUrls = product.IMAGENS.split(',').map(url => url.trim()).filter(url => url);
            if (imageUrls.length > 0) {
                imageUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Imagem de ${product.NOME || 'Produto'}`;
                    img.onerror = function() { this.src = 'https://placehold.co/100x100/ff0000/ffffff?text=Erro!'; this.alt = 'Erro ao carregar imagem';};
                    carouselDiv.appendChild(img);
                });
            } else {
                carouselDiv.innerHTML = '<span style="padding:10px; color:#777;">Sem imagens</span>';
            }
        } else {
            carouselDiv.innerHTML = '<span style="padding:10px; color:#777;">Sem imagens</span>';
        }
        imgCell.appendChild(carouselDiv);
        makeSliderDraggable(carouselDiv); 

        const nameCell = tr.insertCell();
        nameCell.style.width = "30%"; 
        nameCell.textContent = product.NOME || 'N/A';

        const priceCell = tr.insertCell();
        priceCell.style.width = "15%"; 
        priceCell.textContent = product.PRECO ? `R$ ${parseFloat(product.PRECO).toFixed(2)}` : 'N/A';

        const actionsCell = tr.insertCell();
        actionsCell.style.width = "15%"; 
        
        const editButton = document.createElement('button');
        editButton.textContent = 'Editar';
        editButton.className = 'action-button';
        editButton.onclick = () => {
            console.log('Editar produto:', product.ID_PRODUTO, product);
            alert(`Editar produto: ${product.NOME} (ID: ${product.ID_PRODUTO}). Funcionalidade a ser implementada.`);
            // Aqui você preencheria o formulário de adição/edição com os dados de 'product'
            // e mudaria o botão "Adicionar Produto" para "Salvar Alterações", por exemplo.
        };
        actionsCell.appendChild(editButton);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Excluir';
        deleteButton.className = 'action-button';
        deleteButton.onclick = async () => {
            console.log('Excluir produto:', product.ID_PRODUTO);
            if (confirm(`Tem certeza que deseja excluir o produto "${product.NOME}"?`)) {
                await deleteProductOnServer(product.ID_PRODUTO);
            }
        };
        actionsCell.appendChild(deleteButton);
    });
}

/**
 * Função para deletar produto no servidor (Google Apps Script)
 */
async function deleteProductOnServer(productId) {
    if (!window.decodedToken || !window.decodedToken.sub) {
        alert("Usuário não autenticado. Não é possível excluir o produto.");
        return;
    }
     if (!productId) {
        alert("ID do produto não fornecido.");
        return;
    }

    const payload = {
        action: "delete",
        PRODUCT_ID: productId,
        GOGOID: window.decodedToken.sub // Enviar GOGOID para validação no servidor, se necessário
    };

    try {
        const response = await fetch(SCRIPT_URL, { // Usa a constante SCRIPT_URL
            method: 'POST',
            mode: 'no-cors', // MUDANÇA: Usar 'cors'
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorData = { message: `Erro HTTP: ${response.status}`};
            try { errorData = await response.json(); } catch (e) {}
            throw new Error(errorData.message || `Erro ao excluir produto: ${response.statusText}`);
        }

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message || `Produto "${productId}" excluído com sucesso.`);
            loadUserProducts(); 
        } else {
            throw new Error(result.message || 'Falha ao excluir produto no servidor.');
        }
    } catch (error) {
        console.error('Erro ao excluir produto:', error);
        alert(`Falha ao excluir produto: ${error.message}`);
    }
}


/**
 * Carrega os produtos do usuário do Google Apps Script.
 */
async function loadUserProducts() {
    if (!window.decodedToken || !window.decodedToken.sub) {
        console.warn("Token de usuário (GOGOID) não encontrado. Aguardando login...");
        const tableBody = document.querySelector('#Tabeladeprodutos tbody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Autenticação necessária. Verificando...</td></tr>';
        }
        return;
    }

    const gogoId = window.decodedToken.sub;
    const payload = {
        action: "load",
        GOGOID: gogoId
    };
    
    const tableBody = document.querySelector('#Tabeladeprodutos tbody');
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Carregando seus produtos... <div class="loading-spinner" style="display:inline-block; vertical-align:middle;"></div></td></tr>';
    }

    try {
        const response = await fetch(SCRIPT_URL, { // Usa a constante SCRIPT_URL
            method: 'POST', 
            mode: 'no-cors', // MUDANÇA: Garantir que está usando 'cors' (que é o padrão, mas explícito é bom)
            headers: {
                'Content-Type': 'application/json', 
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorText = `Erro HTTP: ${response.status} ${response.statusText}`;
            try {
                const errorData = await response.json(); 
                console.error("Erro do servidor (JSON):", errorData);
                errorText = errorData.message || errorText;
            } catch (e) { 
                const plainError = await response.text();
                console.error("Erro do servidor (texto):", plainError);
                errorText = plainError.substring(0,100) || errorText;
            }
            throw new Error(errorText);
        }

        const data = await response.json(); 

        if (data.status === 'success') {
            displayProductsInTable(data.products);
        } else {
            console.error('Falha ao carregar produtos do servidor:', data.message);
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Falha ao carregar produtos: ${data.message || 'Erro desconhecido do servidor.'}</td></tr>`;
            }
        }
    } catch (error) {
        console.error('Erro na requisição para carregar produtos:', error);
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Erro ao conectar com o servidor: ${error.message}</td></tr>`;
        }
    }
}

window.addEventListener('load', () => {
    // SCRIPT_URL já está definido globalmente no escopo do primeiro script.
    // console.log("Página carregada. URL do Script:", SCRIPT_URL);

    if (window.decodedToken && window.decodedToken.sub) {
        loadUserProducts();
    } else {
        console.log("Token não disponível no 'load'. login.js deve tratar ou redirecionar.");
        const tableBody = document.querySelector('#Tabeladeprodutos tbody');
        if (tableBody && (!tableBody.innerHTML || tableBody.innerHTML.includes('Carregando'))) {
             tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Login necessário para ver os produtos. Verificando...</td></tr>';
        }
    }

    const imagesToAddSlider = document.getElementById('container_imagens_adicionar');
    if (imagesToAddSlider) {
        makeSliderDraggable(imagesToAddSlider);
    }
});

window.addEventListener('userReady', (event) => {
    console.log("Evento 'userReady' recebido. Carregando produtos.");
    loadUserProducts();
});

</script>

</body>
</html>
